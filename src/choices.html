<html>
    <head>
        <link rel="stylesheet" type="text/css" href="/css/style.css">
        <script src="../build/d3.min.js"></script>
        <script src="../build/jquery-3.3.1.min.js"></script>
        <script src="../build/spin.min.js"></script>
    </head>

    <body style="overflow-y:hidden; overflow-x:hidden;" onload="draw_mds()">
        <div id="gadget_chosen"></div>
        <div id="mds_view" style="position: relative">
            <form action="" method="post" name="reload" style="margin-bottom: 0px; top:0.5em; right:1.1em; z-index: 99; position: absolute;">
                <button type="button" onclick="draw_mds()"> Similar Gadgets </button>
            </form>
        </div>

        <script>
            var duration = 200;
            var mds_running = false;
            
            var svgGadgetContainer = d3.select("div#gadget_chosen").append("svg")
              .attr("width", "100%")
              .attr("height", "30%");

            var svgMDSContainer = d3.select("div#mds_view").append("svg")
              .attr("width", "100%")
              .attr("height", "70%");

            var selectedGadget = {data: {params:'', type:'', address:'0', disasm:"Click on a gadget to show the info; Click on the gadget displayed; to add to the chain", mem:['undefined','']}};
            add_gadget_info_window()

            function add_gadget_info_window()
            {
                //parent.document.getElementsByTagName( 'frameset' )[ 0 ].cols="50%, *";
                //document.register.btnadd.style = "visibility: visible";
                svgGadgetContainer.selectAll(".gadget_chosen").remove();

                var chosen_group = svgGadgetContainer.append("g")
                    .classed("gadget_chosen", true)
                

                chosen_group.append("rect")
                    .attr("x", "15%")
                    .attr("y", "5%")
                    .attr("rx", 4)
                    .attr("ry", 4)
                    .attr("width", "70%")
                    .attr("height", "95%")
                    .attr("fill", "#e6f3ff")
                    .style("stroke","black")
                    .on("click", function(d){
                        d3.select(this).transition()
                        .duration(50)
                        .style("fill-opacity", "0.6")
                        .transition()
                        .delay(51)
                        .duration(50)
                        .style("fill-opacity", "1");

                        return chain();
                    });

                chosen_group.append("text")
                    .attr("x","20%")
                    .attr("y", "15%")
                    .attr("dy", 0)
                    .style("opacity", "0")
                    .style("font-weight", 'bold')
                    .style("text-decoration", 'underline')
                    .text(selectedGadget.data.params)
                    .append("tspan")
                    .style("font-weight", 'normal')
                    .style("text-decoration", 'none')
                    .style("display", 'inline-block')
                    .attr("dx", "1.1em")
                    .text(" 0x" + selectedGadget.data.address.toString(16))

                chosen_group.append("text")
                    .attr("x", "20%")
                    .attr("y", "15%")
                    .attr("dy", "2.2em")
                    .style("opacity", "0")
                    .style("font-weight", 'bold')
                    .text("Modified: ")
                    .append("tspan")
                    .style("font-weight", 'normal')
                    .text("" + selectedGadget.data.modified_regs)

                chosen_group.append("text")
                    .attr("x", "20%")
                    .attr("y", "15%")
                    .attr("dy", "3.3em")
                    .style("opacity", "0")
                    .style("font-weight", 'bold')
                    .text("Dereferenced: ")
                    .append("tspan")
                    .style("font-weight", 'normal')
                    .text("" + selectedGadget.data.mem[0])

                chosen_group.append("text")
                    .attr("x", "20%")
                    .attr("y", "15%")
                    .attr("dy", "4.4em")
                    .style("opacity", "0")
                    .style("font-weight", 'bold')
                    .text("Stack Fix: ")
                    .append("tspan")
                    .style("font-weight", 'normal')
                    .text("" + selectedGadget.data.stack_fix)

                chosen_group.append("text")
                    .attr("x","20%")
                    .attr("y", "15%")
                    .attr("dy", "5.5em")
                    .style("opacity", "0")
                    .text(selectedGadget.data.disasm)
                    .call(split_lines);
                
                chosen_group
                    .selectAll('text')
                    .transition()
                    .duration(duration)
                    .style("opacity", "1")


            }

             function split_lines(text) {
              text.each(function() {
                var text = d3.select(this),
                    words = text.text().split(/[;]/).reverse(),
                    word,
                    line = [],
                    lineNumber = 0,
                    lineHeight = 1.1, // ems
                    y = text.attr("y"),
                    dy = parseFloat(text.attr("dy")),
                    tspan = text.text(null).append("tspan").attr("x", "20%").attr("y", y).attr("dy", dy + "em")
                    while (word = words.pop()) {
                    line.push(word)
                    tspan.text(line.join(" "))
                    if (tspan.node().getComputedTextLength() > 0) {
                        line.pop()
                        tspan.text(line.join(" "))
                        line = [word.trim()]
                        tspan = text.append("tspan").attr("x", "20%").attr("y", y).attr("dy", `${++lineNumber * lineHeight + dy}em`).text(word.trim())
                    }
                    }
              })
             }

             function chain(){
               parent.chain.add_block_to_chain(selectedGadget);
             }

             expand = function(r){
                var d = r[1] - r[0],alpha=.1;
                return r.add([-alpha*d, alpha*d]);
            }

            Array.prototype.range = function () {
                return [this.min(), this.max()];
            };

            Array.prototype.max = function () {
                return Math.max.apply(Math, this);
            };

            Array.prototype.min = function () {
                return Math.min.apply(Math, this);
            };

            Array.prototype.add = function (b) {
                var s = Array(this.length);
                for (var ind = 0; ind < this.length; ind++) {
                    if (typeof (b) == "number") {
                        s[ind] = this[ind] + b;
                    }
                    else {
                        s[ind] = this[ind] + b[ind];
                    }
                }
                return s;
            };

            Array.prototype.mult = function (b) {
                var s = Array(this.length);
                for (var ind = 0; ind < this.length; ind++) {
                    if (typeof (b) == "number") {
                        s[ind] = this[ind] * b;
                    }
                    else {
                        s[ind] = this[ind] * b[ind];
                    }
                }
                return s;
            };


            Array.prototype.norm = function () {
                var s = 0;
                for (var ind = 0; ind < this.length; ind++) {
                    s[ind] = this[ind] + b[ind];
                }
                return s;
            };

            d3scatterplot = function(svg,X,labels) {
                var nPix= Math.min(parseInt(document.getElementById("mds_view").offsetHeight), parseInt(document.getElementById("mds_view").offsetWidth))-80,n=X.length,mar = [40,40,40,40];

                var xv = X.map(function(e) { return e.x;}),xRange=expand(xv.range());
                var yv = X.map(function(e) { return e.y;}),yRange=expand(yv.range());

                var sg = svg.append("g")
                    .attr("transform", "translate("
                    + mar[0] + ","
                    + mar[1] + ")");

                var xScale = d3.scaleLinear()
                .range([0, nPix])
                .domain(xRange);

                var yScale = d3.scaleLinear()
                .range([nPix, 0])
                .domain(yRange);

                var dots = sg.selectAll(".datapoint")
                .data(X).enter()
                .append("circle")
                .attr("class", "datapoint")
                .attr("cx",function(d) {return xScale(d.x);})
                .attr("cy",function(d) {return yScale(d.y);})
                .attr("id",function(d,i) {return "point" + i})
                .attr("label", function (d, i) { return labels[i] })

                dots.on('mouseover', function(d) {
                    d3.select(this).style("r", 10);
                })

                dots.on('mouseout', function (d) {
                    d3.select(this).style("r", 5);
                })

                svg.on("mouseout", function (d) {
                    d3.selectAll("circle").style("r", 5);
                })

                var labels = sg.selectAll(".labels")
                    .data(X).enter()
                    .append("text")
                    .attr("class", "label")
                    .attr("x", function (d) { return xScale(d.x); })
                    .attr("y", function (d) { return yScale(d.y); })
                    .text(function (d, i) { return labels[i]; })
                    .attr("font-size", 10)
                    .attr("id", function (d, i) { return "label" + i });

                var xAxis = d3.axisBottom(xScale).ticks(4);
                svg.append("g").call(xAxis)
                .attr("class", "axis")  //Assign "axis" class
                .attr("transform","translate(" + mar[0] + "," + (nPix+mar[1])  + ")");

                var yAxis = d3.axisLeft(yScale).ticks(4);
                svg.append("g").call(yAxis)
                .attr("class", "axis")  //Assign "axis" class
                .attr("transform","translate(" + mar[0] + "," + (mar[3])  + ")");

                dots.on('click', function (d) {
                    console.log(d3.select(this).attr("label").split(','))
                })

            }

            function draw_mds() {
                if(mds_running) return;
                mds_running = true;
                svgMDSContainer.html("")
                var target = document.getElementById('mds_view')
                var spinner = new Spinner().spin(target);
                $.ajax({
                    type: "POST",
                    url: "/mds",
                    data: {params: selectedGadget.data.params, type: selectedGadget.data.type }
                }).done(function (data) {
                    json_data = JSON.parse(data)
                    d3scatterplot(svgMDSContainer, json_data.X, json_data.labels);
                }).always(function () {
                        spinner.stop()
                        mds_running = false;
                });
            }
        </script>
    </body>
</html>
