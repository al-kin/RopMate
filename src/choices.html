<html>
    <head>
        <link rel="stylesheet" type="text/css" href="/css/style.css">
        <script src="../build/d3.min.js"></script>
    </head>

    <body style="overflow-y:hidden; overflow-x:hidden;">
        <div id="gadget_chosen"></div>
        <div id="mds_view"></div>

        <script>
            var svgGadgetContainer = d3.select("div#gadget_chosen").append("svg")
              .attr("width", "100%")
              .attr("height", "30%");

            var svgMDSContainer = d3.select("div#mds_view").append("svg")
              .attr("width", "100%")
              .attr("height", "70%");

            var selectedGadget = {data: {type:'', address:'0', disasm:"Click on a gadget to display it"}};
            add_gadget_info_window()

            function add_gadget_info_window()
            {
                //parent.document.getElementsByTagName( 'frameset' )[ 0 ].cols="50%, *";
                //document.register.btnadd.style = "visibility: visible";
                svgGadgetContainer.selectAll(".gadget_chosen").remove();

                var chosen_group = svgGadgetContainer.append("g")
                .classed("gadget_chosen", true)

                chosen_group.append("rect")
                .attr("x", "15%")
                .attr("y", "5%")
                .attr("rx", 4)
                .attr("ry", 4)
                .attr("width", "70%")
                .attr("height", "90%")
                .attr("fill", "#e6f3ff")
                .style("stroke","black")
                .on("click", function(d){
                    d3.select(this).transition()
                    .duration(50)
                    .style("fill-opacity", "0.6")
                    .transition()
                    .delay(51)
                    .duration(50)
                    .style("fill-opacity", "1");

                    return chain();
                });

                chosen_group.append("text")
                    .attr("x","20%")
                    .attr("y", "15%")
                    .attr("dy", 0)
                    .text(selectedGadget.data.type + " 0x" + selectedGadget.data.address.toString(16))

                chosen_group.append("text")
                    .attr("x","20%")
                    .attr("y", "20%")
                    .attr("dy", 0)
                    .text(selectedGadget.data.disasm)
                    .call(split_lines);
            }

             function split_lines(text) {
              text.each(function() {
                var text = d3.select(this),
                    words = text.text().split(/[;]/).reverse(),
                    word,
                    line = [],
                    lineNumber = 0,
                    lineHeight = 1.1, // ems
                    y = text.attr("y"),
                    dy = parseFloat(text.attr("dy")),
                    tspan = text.text(null).append("tspan").attr("x", "20%").attr("y", y).attr("dy", dy + "em")
                    while (word = words.pop()) {
                    line.push(word)
                    tspan.text(line.join(" "))
                    if (tspan.node().getComputedTextLength() > 0) {
                        line.pop()
                        tspan.text(line.join(" "))
                        line = [word.trim()]
                        tspan = text.append("tspan").attr("x", "20%").attr("y", y).attr("dy", `${++lineNumber * lineHeight + dy}em`).text(word.trim())
                    }
                    }
              })
             }

             function chain(){
               parent.chain.add_block_to_chain(selectedGadget);
             }

             expand = function(r){
                var d = r[1] - r[0],alpha=.1;
                return r.add([-alpha*d, alpha*d]);
            }

            Array.prototype.range = function () {
                return [this.min(), this.max()];
            };

            Array.prototype.max = function () {
                return Math.max.apply(Math, this);
            };

            Array.prototype.min = function () {
                return Math.min.apply(Math, this);
            };

            Array.prototype.add = function (b) {
                var s = Array(this.length);
                for (var ind = 0; ind < this.length; ind++) {
                    if (typeof (b) == "number") {
                        s[ind] = this[ind] + b;
                    }
                    else {
                        s[ind] = this[ind] + b[ind];
                    }
                }
                return s;
            };

            Array.prototype.mult = function (b) {
                var s = Array(this.length);
                for (var ind = 0; ind < this.length; ind++) {
                    if (typeof (b) == "number") {
                        s[ind] = this[ind] * b;
                    }
                    else {
                        s[ind] = this[ind] * b[ind];
                    }
                }
                return s;
            };


            Array.prototype.norm = function () {
                var s = 0;
                for (var ind = 0; ind < this.length; ind++) {
                    s[ind] = this[ind] + b[ind];
                }
                return s;
            };

            d3scatterplot = function(svg,X,cities) {
                var nPix= 0.7*parseInt(window.innerWidth),n=X.length,mar = [40,40,40,40];

                var xv = X.map(function(e) { return e.x;}),xRange=expand(xv.range());
                var yv = X.map(function(e) { return e.y;}),yRange=expand(yv.range());
                svg.attr("width", nPix+mar[0]+mar[2])
                .attr("height", nPix+mar[1]+mar[3]);


                var sg = svg.append("g")
                .attr("transform", "translate("
                    + mar[0] + ","
                    + mar[1] + ")");




                var xScale = d3.scaleLinear()
                .range([0, nPix])
                .domain(xRange);

                var yScale = d3.scaleLinear()
                .range([nPix, 0])
                .domain(yRange);


                var labels = sg.selectAll(".labels")
                .data(X).enter()
                .append("text")
                .attr("class", "label")
                .attr("x",function(d) {return xScale(d.x);})
                .attr("y",function(d) {return yScale(d.y);})
                .text(function(d,i) {return cities[i];})
                .attr("font-size",10)
                .attr("id",function(d,i) {return "label" + i});



                var dots = sg.selectAll(".datapoint")
                .data(X).enter()
                .append("circle")
                .attr("class", "datapoint")
                .attr("cx",function(d) {return xScale(d.x);})
                .attr("cy",function(d) {return yScale(d.y);})
                .attr("id",function(d,i) {return "point" + i})
                .attr("r",2);

                var ghosts = sg.selectAll(".ghost")
                .data(X).enter()
                .append("circle")
                .attr("class", "ghost")
                .attr("cx",function(d) {return xScale(d.x);})
                .attr("cy",function(d) {return yScale(d.y);})
                .attr("r",8);


                console.log(labels);

                var xAxis = d3.axisBottom(xScale).ticks(4);
                svg.append("g").call(xAxis)
                .attr("class", "axis")  //Assign "axis" class
                .attr("transform","translate(" + mar[0] + "," + (nPix+mar[1])  + ")");

                var yAxis = d3.axisLeft(yScale).ticks(4);
                svg.append("g").call(yAxis)
                .attr("class", "axis")  //Assign "axis" class
                .attr("transform","translate(" + mar[0] + "," + (mar[3])  + ")");


                reset = function(el)
                {
                labels.data(X)
                    .attr("x",function(d) {return xScale(d.x);})
                    .attr("y",function(d) {return yScale(d.y);});
                }

            }

            d3.json("data.json").then(function(data) {
                d3scatterplot(svgMDSContainer,data.X,data.cities);
            });
        </script>
    </body>
</html>
