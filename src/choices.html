<html>
    <head>

        <link rel="stylesheet" type="text/css" href="/css/style.css">
        <script src="../build/d3.min.js"></script>
        <script type="text/javascript" language ="javascript">
            function fields(){
                if(document.register.Operation.value != "Nonselezionata"){
                  document.register.param1.style = "visibility: visible"
                }
                return true;
            }

            function verify(){
              var dest = document.register.destination.value;
              if (typeof dest == "string"){
                return ture;
              }
              else{
                window.alert("Invalid destination")
              }
            }
        </script>
    </head>

    <body style="overflow-y:hidden; overflow-x:hidden;">
        <form action="" method ="post" name ="register">
            <div align = center>
                Memory
                <input type ="checkbox" name ="Memory" size ='3' value = 'yes'><br><br>

                Preserved registers<br>
                EAX <input type ="checkbox" name ="eax" size ='3' value = 'yes'>
                EBX <input type ="checkbox" name ="ebx" size ='3' value = 'yes'>
                ECX <input type ="checkbox" name ="ecx" size ='3' value = 'yes'>
                EDX <input type ="checkbox" name ="edx" size ='3' value = 'yes'><br>
                ESP <input type ="checkbox" name ="esp" size ='3' value = 'yes'>
                EBP <input type ="checkbox" name ="ebp" size ='3' value = 'yes'>
                ESI <input type ="checkbox" name ="esi" size ='3' value = 'yes'>
                EDI <input type ="checkbox" name ="edi" size ='3' value = 'yes'><br>

                <br>Destination
                <input type="text" name="destination" size = "5" onchange="return verify();"><br>

                <br>Stack Fix
                <select name ="Stack_fix">
                    <option selected value="Nonselezionata">Non selezionata
                    <option value="4">4
                    <option value="8">8
                    <option value="12"> 12
                    <option value="16"> 16
                </select><br>

                <br>Operation
                <select name ="Operation" onchange="return fields();">
                    <option selected value="Nonselezionata">Non selezionata
                    <option value="LoadConst">LoadConst
                    <option value="CopyReg">CopyReg
                    <option value="ReadMemOp"> ReadMemOp
                    <option value="IncReg"> IncReg
                    <option value="WriteMemOp"> WriteMemOp
                    <option value="SetZero"> SetZero
                    <option value="BinOp"> BinOp
                    <option value="ReadMem"> ReadMem
                    <option value="WriteMem"> WriteMem
                </select><br><br>

                <input type="text" name="param1" placeholder="insert parameter" style="visibility: hidden"><br>
                <input type="text" name="param2" placeholder="insert parameter" style="visibility: hidden"><br>
                <input type="text" name="param3" placeholder="insert parameter" style="visibility: hidden"><br>
                <input type="text" name="param4" placeholder="insert parameter" style="visibility: hidden"><br>
                <input type="text" name="param5" placeholder="insert parameter" style="visibility: hidden"><br>

                <br>
                <input type ="reset" value ="Reset"><br>
                <button type="button" name = "btnadd" id = "btnadd" style="visibility: hidden" onclick = "return chain();"> Add </button>

            </div>
        </form>

        <script>
            var svgContainer = d3.select("body").append("svg")
              .attr("width", "100%")
              .attr("height", "100%");

            var selectedGadget;
            function add_gadget_info_window()
            {
                //parent.document.getElementsByTagName( 'frameset' )[ 0 ].cols="50%, *";
                //document.register.btnadd.style = "visibility: visible";
                svgContainer.selectAll("rect").remove();
                svgContainer.selectAll("text").remove();
                var rectangle = svgContainer.append("rect")
                .attr("x", "15%")
                .attr("y", "5%")
                .attr("rx", 4)
                .attr("ry", 4)
                .attr("width", "70%")
                .attr("height", "20%")
                .attr("fill", "#e6f3ff")
                .style("stroke","black")
                .on("click", function(d){
                    d3.select(this).transition()
                    .duration(50)
                    .style("fill-opacity", "0.6")
                    .transition()
                    .delay(51)
                    .duration(50)
                    .style("fill-opacity", "0.8");

                    return chain();
                });

                svgContainer.append("text")
                    .attr("x","20%")
                    .attr("y", "8%")
                    .attr("dy", 0)
                    .text(selectedGadget.data.type + " 0x" + selectedGadget.data.address.toString(16))

                svgContainer.append("text")
                    .attr("x","20%")
                    .attr("y", "10%")
                    .attr("dy", 0)
                    .text(selectedGadget.data.disasm)
                    .call(split_lines);
            }


            function wrap(text, width) {
              text.each(function() {
                var text = d3.select(this),
                    words = text.text().split(/[;]/).reverse(),
                    word,
                    line = [],
                    lineNumber = 0,
                    lineHeight = 1.1, // ems
                    y = text.attr("y"),
                    dy = parseFloat(text.attr("dy")),
                    tspan = text.text(null).append("tspan").attr("x", "20%").attr("y", y).attr("dy", dy + "em")
                    while (word = words.pop()) {
                    line.push(word)
                    tspan.text(line.join(" "))
                    if (tspan.node().getComputedTextLength() > width) {
                        line.pop()
                        tspan.text(line.join(" "))
                        line = [word]
                        tspan = text.append("tspan").attr("x", "20%").attr("y", y).attr("dy", `${++lineNumber * lineHeight + dy}em`).text(word)
                    }
                    }
              })
             }

             function split_lines(text) {
              text.each(function() {
                var text = d3.select(this),
                    words = text.text().split(/[;]/).reverse(),
                    word,
                    line = [],
                    lineNumber = 0,
                    lineHeight = 1.1, // ems
                    y = text.attr("y"),
                    dy = parseFloat(text.attr("dy")),
                    tspan = text.text(null).append("tspan").attr("x", "20%").attr("y", y).attr("dy", dy + "em")
                    while (word = words.pop()) {
                    line.push(word)
                    tspan.text(line.join(" "))
                    if (tspan.node().getComputedTextLength() > 0) {
                        line.pop()
                        tspan.text(line.join(" "))
                        line = [word.trim()]
                        tspan = text.append("tspan").attr("x", "20%").attr("y", y).attr("dy", `${++lineNumber * lineHeight + dy}em`).text(word.trim())
                    }
                    }
              })
             }

             function chain(){
               parent.chain.add_block_to_chain(selectedGadget);
             }
        </script>
    </body>
</html>
