<html>
    <head>

        <link rel="stylesheet" type="text/css" href="/css/style.css">
    </head>

    <body style="overflow-y:hidden; overflow-x:scroll;">
      <script src="../build/d3.min.js"></script>
      <form action="" method ="post" name ="register">
        <div class="title">
          Result<br>
          <button type="button" onclick="return remove_all();"> Remove all </button>
          <button type="button" onclick="return remove();"> Remove</button>
        </div>
      </form>

      <script>
      //aggiungi testo come hyperlink
      var count = 0;
      var duration = 200;
      var list_gadgets_chain = []
      var dragging = 0

      var svgContainer = d3.select("body").append("svg")
        .attr("width", 20000)
        .attr("height", "100%");

      function add_block_to_chain(selectedGadget){
        if(selectedGadget.data.type != ""){
          count = count + 1;
          if (dragging == 0) list_gadgets_chain.push(selectedGadget)

          var rect_group = svgContainer.append("g")
            .classed("rect" + count, true)
            .style("opacity", "0")
            .call(d3.drag()
              .on("start", dragstarted)
              .on("drag", dragged)
              .on("end", dragended));

          rect_group.append("rect")
            .attr("x", 0)
            .attr("y", 0)
            .attr("rx", 4)
            .attr("ry", 4)
            .attr("width", 150)
            .attr("height", 50)
            .attr("transform", "translate(" + [-130 + (count*180), 60] + ")")
            .on("click", function(d){
              d3.select(this).transition()
                        .duration(50)
                        .style("fill-opacity", "0.6")
                        .transition()
                        .delay(51)
                        .duration(50)
                        .style("fill-opacity", "1");
              parent.choices.selectedGadget = selectedGadget;
              parent.choices.add_gadget_info_window();
              });

          rect_group.append("text")
              .attr("x", 0)
              .attr("y", 0)
              .attr("dy", 0)
              .attr("text-anchor", "middle")
              .attr("dominant-baseline", "central")
              .attr("transform", "translate(" + [-55 + (count*180), 85] + ")")
              .text(trim(selectedGadget.data.params));
              

          if(count > 1){
            rect_group.append("svg:path")
              .attr("d", "M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z")
              .style("stroke-width", 1)
              .style("stroke", "black")
              .attr("fill", "#66c2a4")
              .attr("transform", "translate(" + (-157 + count * 180) + "," + 72.5 + ")");
          }

          rect_group
            .transition()
            .duration(duration)
            .tween("uniquetweenname", scrollLeftTween(180*count - 540));

          rect_group
            .transition()
            .duration(duration)
            .delay(count <= 3? 0:duration)
            .style("opacity", "1")

          if(selectedGadget.data.dest && dragging == 0) {
            parent.frames["controls"].document.getElementById(selectedGadget.data.dest).checked = true;
            add_preserved_reg(selectedGadget.data.dest)
          } 
        }
        
        var gadget_id;
        function dragstarted() {
          gadget_id = d3.select(this).attr("class").charAt(4) - 1
        }

        function dragged(d) {
          d3.select(this).attr("transform", function(d,i){
            return "translate(" + [d3.event.x - (gadget_id + 1)*120 - gadget_id*60 , d3.event.y - 80] + ")"
          })
        }

        function dragended() {
          ending_position = Math.floor((d3.event.x +130)/180 + 0.5) - 1
          if(ending_position < 0) ending_position = 0;
          var length_chain = list_gadgets_chain.length;
          if(ending_position > (length_chain - 1)) ending_position = length_chain - 1;
          if(gadget_id >= ending_position){
              var store_actual_count = count;
              dragging = 1;
              count = ending_position + 1;
              remove();
              add_block_to_chain(list_gadgets_chain[gadget_id]);
              for(var i = ending_position; i < gadget_id; i++){
                count++
                remove();
                add_block_to_chain(list_gadgets_chain[i]);
              }
              var moved_gadget = list_gadgets_chain[gadget_id]
              for(var i = gadget_id; i > ending_position; i--){
                list_gadgets_chain[i] = list_gadgets_chain[i-1]
              }
              list_gadgets_chain[i] = moved_gadget
              count = store_actual_count;
              dragging = 0
          }

          else{
            var store_actual_count = count;
            dragging = 1;
            count = ending_position + 1;
            remove();
            add_block_to_chain(list_gadgets_chain[gadget_id]);
            for(var i = ending_position; i > gadget_id; i--){
              count--;
              remove();
              add_block_to_chain(list_gadgets_chain[i]);
            }
            var moved_gadget = list_gadgets_chain[gadget_id]
            for(var i = gadget_id; i < ending_position; i++){
              list_gadgets_chain[i] = list_gadgets_chain[i+1]
            }
            list_gadgets_chain[i] = moved_gadget
            console.log(list_gadgets_chain.length)
            count = store_actual_count;
            dragging = 0
          }
        }
      }

      function scrollLeftTween(scrollLeft) {
          return function () {
            var i = d3.interpolateNumber(scrollLeft-180, scrollLeft);
            return function (t) {window.scrollTo(i(t),0); };
          };
        }

      function scrollRightTween(scrollLeft, all) {
          return function () {
            var i = d3.interpolateNumber(scrollLeft, all ? 0 : scrollLeft-180);
            return function (t) { window.scrollTo(i(t), 0); };
          };
        }

      function trim(text) {
        if(text.length > 18) 
        {
          // replace long addresses with '0x...'
          if(text.includes('0x')) return text.replace(/(.*)0x[0123456789abcdef]+(.*)/, "$10x...$2")
          else return text.substring(0, 16) + "..."
        }
        else return text;
      }

      function add_preserved_reg(reg) {
            if (!parent.tree.filter.preserved_regs.includes(reg))
              parent.tree.filter.preserved_regs.push(reg)
              parent.tree.reload()
        }

      function remove_all(){
        svgContainer.selectAll("g")
          .transition()
          .duration(duration)
          .style("opacity", "0")

        svgContainer.selectAll("g")
          .transition()
          .duration(duration)
          .delay(duration)
          .tween("uniquetweenname", scrollRightTween(180 * count - 540, true))
          .remove();
        count = 0;
        list_gadgets_chain = []
      }

      function remove(){
        if(count > 0){
          svgContainer.selectAll(".rect" + count)
            .transition()
            .duration(duration)
            .style("opacity", "0")

          svgContainer.selectAll(".rect" + count)
            .transition()
            .duration(duration)
            .delay(duration)
            .tween("uniquetweenname", scrollRightTween(180 * count - 540, false))
            .remove()

          count = count - 1;
        }
      }

    </script>

    </body>
</html>
